<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <title>Heap Dump Stats</title>
  <style>
    :root{--bg:#0b1220;--fg:#e9eef5;--acc:#3b82f6;--mut:#96a0b5}
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--fg);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .panel{background:#0f172a;border:1px solid #223;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:20px;width:min(1000px,100%)}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:0 0 12px;color:var(--mut)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px}
    button{padding:10px 14px;border-radius:10px;border:0;background:var(--acc);color:#fff;cursor:pointer}
    button.secondary{background:#1f2937;color:var(--fg)}
    .status{font-size:14px;color:var(--mut)}
    .output{margin-top:16px;background:#050910;border:1px solid #223;border-radius:12px;padding:14px;white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px;max-height:60vh;overflow:auto}
    progress{width:100%;height:12px;margin-top:10px}
    a{color:#93c5fd;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <section class="panel">
    <h1>Heap Dump Stats (JOL)</h1>
    <p>Upload a <code>.hprof</code> heap dump over a native WebSocket and receive the same stats as <code>jol-cli heapdump-stats</code>.</p>
    <p><a href="/index.html">← Back to JFR merge</a></p>

    <input id="fileInput" type="file" accept=".hprof" hidden>
    <div class="row">
      <button id="pick" class="secondary" type="button">Choose heap dump</button>
      <button id="send" type="button" disabled>Send over WebSocket</button>
      <span id="fileName" class="status">No file selected.</span>
    </div>
    <progress id="progress" max="100" value="0" hidden></progress>
    <div id="status" class="status"></div>
    <pre id="output" class="output" aria-live="polite"></pre>
  </section>

<script>
(() => {
  'use strict';
  const pickBtn = document.getElementById('pick');
  const sendBtn = document.getElementById('send');
  const fileInput = document.getElementById('fileInput');
  const fileName = document.getElementById('fileName');
  const status = document.getElementById('status');
  const output = document.getElementById('output');
  const progress = document.getElementById('progress');

  let selectedFile = null;
  let socket = null;
  let bytesSent = 0;

  const setStatus = (text) => { status.textContent = text; };
  const resetOutput = () => { output.textContent = ''; };
  const wsUrl = () => {
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    return `${proto}://${location.host}/ws/heapdump`;
  };

  pickBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (event) => {
    selectedFile = event.target.files[0] || null;
    if (selectedFile) {
      fileName.textContent = `${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MiB)`;
      sendBtn.disabled = false;
    } else {
      fileName.textContent = 'No file selected.';
      sendBtn.disabled = true;
    }
  });

  const sendChunks = async (file) => {
    const chunkSize = 512 * 1024;
    let offset = 0;
    while (offset < file.size) {
      const chunk = file.slice(offset, offset + chunkSize);
      const buf = await chunk.arrayBuffer();
      socket.send(buf);
      offset += chunkSize;
      bytesSent = offset;
      const pct = Math.min(100, Math.floor((bytesSent / file.size) * 100));
      progress.value = pct;
    }
    socket.send(JSON.stringify({type: 'finish'}));
  };

  const connectAndSend = () => {
    if (!selectedFile) return;
    resetOutput();
    progress.hidden = false;
    progress.value = 0;
    bytesSent = 0;
    setStatus('Connecting WebSocket…');

    socket = new WebSocket(wsUrl());
    socket.binaryType = 'arraybuffer';

    socket.addEventListener('open', () => {
      setStatus('Socket connected. Uploading…');
      socket.send(JSON.stringify({type: 'start', filename: selectedFile.name, size: selectedFile.size}));
    });

    socket.addEventListener('message', async (event) => {
      if (typeof event.data !== 'string') return;
      let payload = null;
      try { payload = JSON.parse(event.data); } catch { return; }
      if (payload.type === 'ready') {
        await sendChunks(selectedFile);
        setStatus('Upload complete. Processing heap dump…');
      } else if (payload.type === 'progress') {
        if (selectedFile?.size) {
          const pct = Math.min(100, Math.floor((payload.bytes / selectedFile.size) * 100));
          progress.value = pct;
        }
      } else if (payload.type === 'processing') {
        setStatus('Processing heap dump…');
      } else if (payload.type === 'stats') {
        setStatus('Done.');
        output.textContent = payload.text || '';
      } else if (payload.type === 'error') {
        setStatus(`Error: ${payload.message || 'unknown error'}`);
      }
    });

    socket.addEventListener('close', () => {
      setStatus('Socket closed.');
    });

    socket.addEventListener('error', () => {
      setStatus('WebSocket error.');
    });
  };

  sendBtn.addEventListener('click', connectAndSend);
})();
</script>
</body>
</html>
